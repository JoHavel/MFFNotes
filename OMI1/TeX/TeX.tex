\documentclass[12pt]{article}					% Začátek dokumentu
\usepackage{../../MFFStyle}					    % Import stylu



\begin{document}

\section*{Organizační úvod}
    Bude odevzdávací systém, zatím odevzdávat domácí úkoly. (Musíme splnit něco jako 7 domácích úkolů).

\section{Úvod}
    .tex + .tfm (tex font metric = rozměry písmen) $\leftarrow$ TEX $\leftarrow$ DVI (formát nezávislý na OS) $\leftarrow$ DVI moduly = DVI drivery (dvips, xdvi, pdftex (ten navíc potřebuje .tfm a fonty)).

    \TeX umí primitiva. V tom se ale sázení řídí špatně, tedy existují nadstavby (plain\TeX, nadstavba od autora, nad nim jsou postavené con\TeX t, opmac a \LaTeX) a nadstavby mimo, jako AMS\TeX, Xe\TeX, Bib\TeX.

    tex nebo pdftex spouští plain\TeX nebo s přepínačem -ini ini\TeX, který umí zkompilovat makra do formatu.

    Literatura:
    \begin{itemize}
        \item Knuth: The \TeX book: nejdřív je to takový tutoriál, potom \TeX uvnitř
        \item Olšák: \TeX book naruby: v opačném pořadí, česky
        \item Knuth: \TeX the program (popsaný zdroják \TeX u)
    \end{itemize}

    \subsection{Sazba odstavce}
        Vstup = horizontální seznam $\rightarrow$ (proces předělání se spouští příkazem par) zalámaný odstavec

        Horizontální seznam obsahuje:
        \begin{itemize}
            \item box (h, d, w): písmenko, slitek (ligatura), hbox / vbox
            \item linka (h, d, w): hrule, vrule (liší se tím, kde se mohou vyskytnout, tedy hrule nepatří do horizontálního seznamu)
            \item discretionary break (pevné šířky): nobreak (stav bez rozdělení) pre-break (na konci řádku) post-break (na začátku dalšího), nesmí obsahovat pružné věci

            \item whatsit (?): přepínač jazyka, …
            \item vertikální materiál (nemá vliv na horizontální sazbu, při zlomu vypadne do vertikálního seznamu), objeví se například po řádku s \verb'\vadjust{…}'
            \item lepidlo (= glue) (= pružné výplňky) -- věc s fixní šířkou, roztažitelností a stlačitelností (ty se udávají buď přímo v jednotkách jako px apod, nebo v jednom ze 3 nekonečen (také jednotka) fil, fill, filll).
            \item kern (= pevné výplňky) -- věc pouze s fixní šířkou, automaticky vzniká například pro oddálení kulatých písmen / přiblížení plochých…
            \item penalty (= trest) -- číslo, které říká, jak moc chceme / nechceme zlomit
            \item math on/off -- zapíná a vypíná matematiku

        \end{itemize}
        Prvních 5 je non-discardable (jsou vidět). Ostatní discardable.

        Možná místa zlomu jsou:
        \begin{itemize}
            \item glue (když před sebou má něco non-disc. a není uvnitř math)
            \item před kernem (když za ním je glue a není uvnitř math)
            \item math off (následovaný glue)
            \item v penaltě (ne větší než 10000)
            \item v discretionary breaku (ten se ale přidává až při druhém průchodu = když se nezalomí bez něho)
        \end{itemize}

        V zlomu se z předchozích věcí stane box řádku, u kterého se spočítají rozměry a spočítá se, jak moc je tento zlom špatný (badness), tím se vybere ten nejlepší zlom a vysází se „jeho“ řádek. Následně se zahodí všechny discardable věci a pokračuje se na dalším řádku.

        Badness boxu se počítá (pokud součet nekonečných roztažitelností není nula, pak je badness 0):
        $$ \left\lceil 100 \cdot \(\frac{\text{deformace}}{\text{pružnost(součet roztažitelností / stlačitelností)}}\)^3 \right\rceil $$

        Roztahuje (stlačuje) se v nejvyšším nenulovém nekonečnu a to v poměru hodnot roztažnosti.

        Nestlačuje se o více jak 100\% (dá badness ∞).

        \verb|\hbadness| říká badness, při které už se vypisuje, že se \TeX pokusí (už ho dělá, nevybírá) vysázet box s touto badness.

        \verb|\tolerance| (při prvním průchodu \verb|\pretolerance|, která je zpravidla o dost nižší) říká, že větší badness už se zahazuje. Při třetím průchodu už se používá, že roztažnost zvýšíme o \verb|\emergencystretch|

        Lámání odstavce funguje tak, že se prohledají zlomy (každý bod zlomu se dá považovat za vrchol grafu, hrany jsou ohodnoceny tzv. demerits (počítá se z badness a dalších věcí)).

        Demerits:
        $$ (l + b)^2 \pm p^2 + extras $$ (l = \verb|\linepenalty| -- přidává se vždy (aby se nelámalo všude, kde lze), b = badness, p = penalta na níž se láme resp. \verb|\hyphenpenalty| nebo \verb|\exhyphenpenalty|, extras = \verb|\adjdemerits| (10000, přidává se, když typ řádku není sousední -- aby nebyl velmi roztažen, když předchozí byl stlačen) + \verb|\doublehyphendemerits| (10000, přidává se, když vyjdou 2 neprázdné pre-breaky za sebou) + \verb|\finaldemerits| (5000, neláme se na předposledním řádku odstavce))

        Typ řádku: 0 (roztažení o více jak 100\%), 1 (roztažení o 50-100\%), 2 (změna max. o 50\%), 3 (stlačení o  více jak 50\%)


    \begin{priklad}[Domácí úkol]
        Zkuste vymyslet, co naskládat do horizontálního seznamu, aby se mezera dala zlomit, ale zůstala na dalším řádku.
    \end{priklad}

    Příště tvar odstavce (left / right)skip, jak vzniká hor. seznam, algoritmus na pakování boxů.

% 12. 10. 2020

    \begin{poznamka}[Vzniky horizontálních věcí]
        Boxy (znaky, ligatury, \verb|\hbox to 10cm {…}|, \verb|\vbox spread 5mm{…}| (podle v/h se skládá obsah uvnitř boxu, to nastavuje velikost, spread zvětšuje velikost))

        Linky (\verb|\vrule width 3pt height 10pt depth 1pt|)

        Kerny (\verb|\kern 30pt|)

        Glue (\verb|\hskip 10pt plus 2pt minus 1fil|, \verb|hfil|, \verb|hfill|, \verb|hss|)

        Penalty (\verb|penalty 100|, \verb|\nobreak|, \verb|break|, \verb|\allowbreak|)

        Discr. break (\verb|\discretionary{pre}{post}{no}|)

        Etc.
    \end{poznamka}

    \begin{definice}[Box packing]
        Spočítáme výsledné rozměry a deformace, pokládám věci na baseline, pomocí výšky a hloubky (příkazy \verb|\raise 10pt \hbox{…}| a \verb|\lower| se dají posunovat boxy vůči baseline).

        Deformujeme glue.

        Určí se neurčité rozměry linek.

        Vertikálně se naopak pokládají referenčními body na jednu linku vlevo (zase existuje \verb|\moveleft| a \verb|\moveright|). Výška se pak určuje jako součet výšek a hloubek boxů uvnitř. Hloubka se počítá podle posledního boxu a pak se minimuje na \verb|\boxmaxdepth| u explicitních \verb|\maxdepth| u stránkových zlomů.

        \begin{poznamkain}
            Na určování rozměrů se hodí tzv. podpěry (linky nulové šířky s nenulovou výškou nebo hloubkou).
        \end{poznamkain}

        \begin{poznamkain}
            Lze získat rozměry před i po deformaci.
        \end{poznamkain}
    \end{definice}

    \begin{definice}[Sázení písmenek]
        Font dimen: sklon std.mezera, roztažnost, smrštitelnost, ex, em, extra mezera…

        Spacefaktor je na počátku 1000. Pokud sf znaku $≠ 0$: přenastavýme (leda že by sf znaku > 1000 a my jsme < 1000, pak nastavíme na 1000). Mezera: velikost: std.mezera + extramezera (pokud $sf≥1000$), roztažnost: $fd3 \cdot sf/1000$, smrštitelnost: $fd4 \cdot 1000/sf$.

        \begin{poznamka}[Nastavení pro angličitnu]
                A-Z: 999, a-z: 1000, .!?: 3000, ,: 1250, (): 0
        \end{poznamka}

        Existuje i explicitní \verb|\spacefactor 1234|, \verb|\frenchspacing| (nastavuje češtinu), \verb|\nonfrenchspacing| (nastavuje angličtinu), \verb|\spaceskip=5mm| (spaceskip překřičí font dimen aktuálního fontu) a \verb|\xspace=3mm| (použije se, když je moc velký sf).
    \end{definice}

    \begin{poznamka}[Některé příkazy]
        \verb|\line{…} = \hbox to \hsize{…}|

        \verb|\centerline{…} = \line{\hss…\hss}|

        \verb|\rlap{…} = \hbox to 0pt{…\hss}| (Box nulové šířky s vyčuhujícím materiálem doleva)

        \verb|\llap{…} = \hbox to 0pt{\hss…}| (Box nulové šířky s vyčuhujícím materiálem doprava)
    \end{poznamka}

    \begin{definice}[Dělení slov]
        Pro každý jazyk má \TeX trie, jak slovo dělit.

        Existuje makro \verb|\chyph|, které přepne do češtiny.
    \end{definice}

% 19. 10. 2020

    \begin{definice}[Módy fungování v \TeX u]
        (Přesněji řečeno módy hlavního procesoru)
        \begin{itemize}
            \item Vertikální hlavní (stránkový)
            \item Vertikální vnitřní (\verb|\vbox|)
            \item Horizontální odstavcový (zalamování)
            \item Horizontální vnitřní / restricted (\verb|\vbox|)
            \item Matematický vnitřní (\verb|$|)
            \item Matematický display (\verb|$$|)
        \end{itemize}

        Na začátku je \TeX v hlavním vertikálním módu. Teprve ve chvíli, kdy najde něco, co by mělo být v odstavci (písmenko, \verb|\noindent|, \verb|\indent|, \verb|\leavevmode| (jako písmenko), \verb|\hskip|, \verb|\vrule|), tak se \TeX přesune do odstavcového horizontálního.

        Zpět se přesouvá příkazy (\verb|\par| (tj. i 2 odřádkování), vertikálními povely: \verb|\par|, \verb|\vskip|, …, \verb|}| ukončující \verb|\vbox|), což vyvolá odstavcový zlom a vrácení se do hlavního vertikálního.

        Obdobně ostatní přechody (pozor, lze přecházet i z Vertikálního vnitřního do odstavcového, naopak nelze přecházet z vertikálních do matematických, tam se automaticky přechází přes horizontální).
    \end{definice}
    
    \begin{poznamka}[Co dostane lámací algoritmus]
        Na začátku prázdný \emph{box} šířky \verb|\parindent|. Následuje horizontální materiál odstavce a „ocásek“, ve kterém je \verb|\unskip| (odstranění poslední mezery), \verb|\nobreak|, glue velikosti \verb|\parfillskip = 0 plus 1 fil|, \verb|\break|. 
        
        \begin{poznamkain}[Co lze]
            Přenastavit \verb|\parfillskip = \parindent| (pak bude odstavec, když to vyjde, symetrické).

            Přenastavit \verb|\parfillspi = 1cm plus 1fil| (např. když máme malou mezeru mezi odstavci a chceme uživatele upozornit na konec odstavce, i když vychází do konce řádku).
        \end{poznamkain}
    \end{poznamka}

    \begin{poznamka}[Sestavení řádku]
        Horizontální materiál řádku se obalí \verb|\leftskip = 0pt| zleva a \verb|\rihtskip = 0pt| zprava a zavře se do \verb|\hbox| velikosti \verb|\hsize|.

        Sázení na praporek lze vytvořit tím, že nastavíme \verb|\rightskip = 0pt plus 1 fil|, ale pak se budou řádky snadno lámat (nebudou se rozdělovat slova, budou kratší řádky). Správně na to existuje makro \verb|\raggedright|, které udělá \verb|\rightskip 0pt plus 4em\spaceskip=…\xspaceskip=…| (nastaví mezislovní a písmenné mezery na pevné, aby se neroztahovali podle smršťování a roztahování té mezery na konci).

        Centrování \verb|\leftskip = \rightskip = 0,4 plus 2em\parfillskip = 0pt|.
    \end{poznamka}

    \begin{poznamka}[Tvar odstavce]
        Vykousnutí se nastavuje \verb|\handindent| (rozměr, o kolik se odsadí) a \verb|\hadgafter| (číslo, kolik řádků se odsadí), když se nastaví záporné hodnoty, vykusují se intuitivně ostatní rohy odstavce. Na konci odstavce se nuluje.

        Následuje \verb|\parshape = n p1 w1 … pn wn| (kolik se má odsadit, o kolik které, poslední se opakuje do nekonečna). Také se nuluje.

        Když zrovna nejsme ve vertikálním módu, tak se v \verb|\prevgraf| uchovává počet řádků v předchozím odstavci.

        Existuje makro \verb|\everypar|, které spustí nastavený kód každý odstavec.

        Můžeme si objednat zmenšení / zvětšení počtu řádků \verb|\looseness = n| (- je kratší, pokud nelze vyplnit, bude ignorováno). 
    \end{poznamka}

    \begin{poznamka}[Výsledek lámání odstavce: vertikální materiál]
        \begin{itemize}
            \item $\forall$ řádek jako box + posunutí referenčního bodu (žádné glue).
            \item Dále z boxů vypadají vertikální věci (\verb|vadjust|, \verb|mark|).
            \item Penalty mezi řádky (\verb|\interlinepenalty = 0| + \verb|clubpenalty = 150| (po prvním řádku) + \verb|widowpenalty = 150| (před posledním řádkem) + \verb|\brokenpenalty = 100| (po pre-break) + \verb|\displaywidowpenalty| (aby nebyla osamocená display matematika)).
            \item Ještě se objeví vertikální (zde řádkové) mezery, ale ty probereme zvlášť.
        \end{itemize}
    \end{poznamka}

    \begin{definice}[Řádkování]
        Algoritmus, aby se pokud možno dodrželo řádkování (ale řádky mohou být různě široké). Řídí se 3 parametry: \verb|\baselineskip| (glue), \verb|lineskiplimit = 0pt| (dimen) a \verb|lineskip = 1pt| (glue).

        Vypočítá mezeru jako $skip = bls - d_{horni} - h_{spodni}$. Pokud vyjde $skip < lsl$, nastaví se $skip = ls$. (Při více stránkách není dobré nastavovat pružnost těchto mezer).

        vskip, kern, penalty ignorujeme, hrule algoritmus potlačí.

        \begin{poznamkain}[Jak je to doopravdy]
                V registru \verb|\prevdepth| = hloubka posledního boxu (\verb|-1000pt|: algoritmus potlačen), linka nastaví právě ten dolní limit.

                \verb|\nointerlineskip| je \verb|\prevdepth = -1000pt|. \verb|\offinterlineskip| úplně zastaví tento algoritmus \verb|\baselineskip = -1000pt, \lineskip = 0, \lineskiplimit = \maxdimen|
        \end{poznamkain}
    \end{definice}

    \begin{poznamka}[Usazení 1. řádku na stránce (pouze hlavní vertikální mód)]
        Snažíme se spočítat glue tak, aby výška mezery + výška 1. řádku vyšla \verb|\topskip|, ale není nikdy záporný.

        Rozdíl proti řádkovému: nemáme limit (vždy je 0pt) a uvažujeme linky.
    \end{poznamka}

% 26. 10. 2020

    \begin{poznamka}[Ještě k předchozímu]
        Na začátku odstavce se vloží \verb|\parskip|.
    \end{poznamka}

\section{registry}
    \begin{definice}
        Registry jsou zabudované (konkrétní počet; pojmenované; spousta nastavení, o kterých jsme mluvili) a uživatelské (0…255 každého typu, často (u dalších „TeXů“) i více).

        Typy:
        \begin{itemize}
            \item \verb|\count| -- číslo (31 bitů + znaménko)
            \item \verb|\dimen| -- rozměr (30 bitů + znaménko ve sp $= 2^{-16}$ pt\footnote{pt = 1in/72,27}, tj. 14 celá část, 16 desetinná)
            \item \verb|\skip| -- roztažnost (13+16 bitů)
            \item \verb|\muskip| -- matematický (speciální jednotky)
            \item toks, box, …
        \end{itemize}

        Registry se obnovují po konci grupy na začínající stav.

        Použití: lze do nich dosazovat (\verb|\count74=32|\footnote{Číslo lze napsat číslicemi s desetinnou tečkou, apostrof a osmičková soustava, 2 apostrofy a šestnáctková ve velkých písmenech, obrácený apostrof znak resp lomítko znak, hodnota registru a backslash pojmenovaný znak (pomocí *chardef*ch=kód (*=lomítko) to však \TeX užívá spíše uvnitř).}, \verb|\parskip=10pt| (rovnítka lze vyměnit za mezeru, či vynechat)), lze ho použít jako jednotky, vypsat ho (\verb|\the\count5|) (do pdf), vypsat ho (\verb|\showthe\count5|) (do logu), použít jako pointer (\verb|\count\count5|), automaticky konvertovat dimen $\rightarrow$ skip nebo skip $\rightarrow$ dimen $\rightarrow$ count. 
    \end{definice}

    \begin{definice}[Aritmetika]
        \verb|\advanced registr by hodnota| (by lze vynechat nebo napsat BY)\\
        \verb|\multiply| (pouze celými čísly)\\
        \verb|\divide| (pouze celými čísly), zaokrouhluje se k nule
    \end{definice}

    \begin{definice}[Alokace registrů]
        \ 
        \begin{itemize}
            \item count 0…9 = číslo stránky
            \item box 255 = přenos obsahu do output rutiny
            \item reg. 0…9 = pracovní (krom čísel stránek)
            \item \verb|\countdef\jmeno=cislo| -- nastavuje přezdívku za registr s číslem cislo
            \item \verb|\newcount\pocitadlo| -- (plain) alokuje nějaký registr (interně \verb|\countdef\pocitadlo|)
            \item \verb|\newinsert\…| -- (plain) alokuje vše, co potřebuje na insert, viz dále 
        \end{itemize}
    \end{definice}

    \begin{definice}[Boxový registr]
        Obsahuje nic, hbox nebo vbox.

        Lze ho nastavit (\verb|\setbox0=\hbox{…}|), přemístit na aktuální místo (\verb|\box0|), vložit na aktuální místo (\verb|\copy0|), přemístit / vložit jejich obsah na aktuální místo (\verb|\unhbox0|, \verb|unvbox|, \verb|unhcopy|, \verb|\unvcopy|), měřit / měnit rozměry (\verb|\wd0|, \verb|\ht0|, \verb|\dp0|)\footnote{toho využívají plainová makra *phantom$\{…\}$, *hphantom$\{…\}$, *vphantom$\{…\}$ (*=lomítko), které vytvoří prázdné boxy velikosti jejich obsahů.}, (\verb|\showbox0|), (\verb|\newbox\cs|).
    \end{definice}

\section{Stránkový zlom}

    \begin{definice}[Obsah vertikálního seznamu]
        \ 
        \begin{itemize}
            \item box
            \item linka
            \item odkaz na insert (plovoucí obsah)
            \item mark
            \item whatsit (třeba zápis do souboru \verb|\write|, \verb|\special| viz dále)
            \item glue
            \item kern
            \item penalty
        \end{itemize}

        Prvních 5 je non-discardable.
    \end{definice}

    \begin{definice}[Stránkový zlom]
        Místa zlomu: glue, před nímž je non-disc., kern za glue, penalta $< 10000$.

        Nebyl dostatek pamětí na obtížnější, tedy se postupně přidávají prvky, počítá se cost ta je na začátku 100000, protože by se obsah moc roztáhl, pak jsou rozumné a někdy dojde na nekonečno, kde algoritmus najde zpětně nejlepší zlom (pamatuje si ho, ze stejných vybere ten poslední = nejplnější) a tam zlomí.

        Cost\footnote{c = cost, b = badness, p = penalta, q = dodatečná penalta}: 1) $b<∞, p≤-10000, q<1000: c := p$, 2) $b < 10000, p \in \(-10000,10000\), q < 10000: c:= b+p+q$, 3) $b=10000 (underfull), \text{ostatní konečné jako v 2)}: c:=100000$, 4) jinak: $c:=+∞$.

        Pamatuje si \verb|\pagetotal|, kde si pamatuje, co už má na stránce, \verb|\pagestretch…|, kde si pamatuje počty roztažností, a \verb|\pagegoal|, kde si pamatuje výšku (bez plovoucích tedy \verb|\vsize|).
    
    \end{definice}

    \begin{priklad}
        Plain má makro \verb|\raggedbottom|, který nechá vlát dole (pružný konec stránk), vytvořte ho.
    \end{priklad}

% 2. 11. 2020

    Algoritmus na lámání stránky lze vyvolat i explicitně pomocí \verb|\vsplit (číslo boxu s vertikálním materiálem) to rozměr|, jež se pokusí vysázet vertikální materiál na stránku výšky rozměr (na konci se poslední hloubka „minimalizuje“ s rozměrem \verb|\splitmaxdepth|), odstraní všechno discardable a na začátek „druhé poloviny“ vloží \verb|\splittopskip|. Nedozvíme se však, jak moc se to povedlo (krom zařvání do logu při přetečení).

    \begin{poznamka}[Motivace k inzertům]
        Chceme sázet plovoucí věci (poznámky pod čarou, figury, …), navíc chceme zajistit, aby se např. poznámky mohly lámat (např při omezení zabraného místa poznámkami, nebo když značka (odkaz na poznámku) vyjde na úplný konec řádky). Navíc se musí zajistit třeba vytvoření místa pro čáru nad poznámkami.
    \end{poznamka}

    \begin{definice}[Inzerty]
        \verb|\newinsert\footins| zarezervuje (vše s jedním číslem \verb|N| a aliasem \verb|\footins|) box \verb|\box N| (Tam se skladuje vertikální materiál k tomuto insertu), \verb|\count N| (nějaké promile udávající kolik místa zabere vertikální materiál (např. pro tři sloupečky by to bylo 333)), \verb|\dimen N| (maximální zabraná výška tímto insertem), \verb|\skip N| (místo před prvním objektem daného typu na stránce).

        Insert vložíme \verb|\insert N{vertikální materiál}|, kterýžto vloží značku do vertikálního módu (v horizontálním pomocí \verb|\vadjust|), pozor značka nevypadne z boxu.

        Inserty se řadí ke třídám podle čísla, kterým se rezervuje.
    \end{definice}

    \begin{definice}[Algoritmus]
            Na vstupu je insert třídy \verb|N| (odkaz na).


        \begin{enumerate}
            \item Jestliže zatím nebyl žádný insert této třídy, snížíme \verb|\pagegoal| o (výška + hloubka (toho co tam zůstalo z minule)) \verb|\count N|/1000 + velikost \verb|\skip N| (další rozměry \verb|skip N| se přidají do \verb|\pagestretch| a spol.).
            \item Jestliže byl předchozí insert třídy \verb|N| rozdělen (skončíme): \verb|\insertpenalties += \floatingpenalty|.
            \item Vejde se na stránku vcelku? (a) výška + hloubka insertů třídy \verb|N| po vložení $<$ \verb|\dimen N|. (b) \verb|x| = (výška + hloubka) \verb|\count N|/1000 $≤$ 0 nebo \verb|\pagetotal + \pagedepth + x - \pageshrink| $≤$ \verb|pagegoal|. Pokud ano, \verb|\pagegoal -= x| a materiál se přesune do aktuálního obsahu insertů třídy N.
            \item Pokud se nevešlo: spočteme maximální výšku \verb|h|, která neporuší (a) ani (b) bez \verb|\pageshrink|, a zavolá se \verb|\vsplit to h| (vršek se připraví na přidání na stránku a \verb|\pagegoal| se sníží o jeho výšku + hloubku, spodek se pošle zpět do tzv. přípravné oblasti, penalta ze zlom -> přičteme k \verb|\insertpenalties|)
        \end{enumerate}
    \end{definice}

%    \begin{definice}[Neví ani Medvěd, jak to má fungovat]
%        \verb|\holdinginserts| > 0 (inserty zůstávají na původních místech), ≤0 ()
%    \end{definice}

\section{Output rutina}
    Lze ji předefinovat \verb|\output={…}| (tj. přiřazení do registru \verb|\tokens|).

    \begin{definice}
        Vstup = box 255 (hlavní obsah strany), box N (inserty, které se vešly), značky(TODO), \verb|\outputpenalty| (penalta, na které se zlomilo, jinak 10000).

        Výstup \verb|\shipout{box}| (vysypání boxu do výstupního souboru (dvi / pdf)), vertikální materiál (vrací se zpět do přípravné oblasti).

        \begin{upozorneni}
            Output rutina běží uvnitř implicitních složených závorek (ve vlastní grupě, lze obejít nastavováním věcí přes \verb|\global|).

            Nepředvídatelný stav \TeX{}u (nemůžeme vědět, jak jsou nastavené parametry, které v dokumentu měníme).
        \end{upozorneni}

        Kde je následný \verb|\shipout| usazen nastavují parametry \verb|\hoffset| a \verb|\voffset|, které jsou zřejmé, až na to, že jejich měření začíná palec od okraje stránky. PdfTeX má navíc (\verb|\pdfvorigin| a \verb|\pdfhorigin|, kterými lze změnit ten palec a \verb|\pdfpageheight| a \verb|\pdfpagewidth|).
    \end{definice}

    (Přípravná oblast obsahuje zbytky rozlomených insertů, vertikální materiál z output rutiny, element, na kterém se lámalo (resp. penalta 10000, pokud se lámalo na penaltě), materiál za místem zlomu, zbytek předchozí přípravné oblasti.)

    \begin{definice}[Plain output rutina]
        \verb|\headline={…}| a \verb|\footline={…}|, kde si můžeme nastavit obsah hlavičky a patičky, sází se s \verb|\line| roztažený na \verb|\hsize|.

        Čísla stránek: \verb|\folio| (záporné \verb|\pageno| způsobí (ve \verb|\folio|) vysázení římského čísla a snížení \verb|\pageno| o jedna).

        \verb|\footnote{odkaz}{poznamka}|, \verb|\topinsert| (vloží materiál na začátek některé z dalších stránek) + \verb|\midinsert| (spočítá, jestli se to ještě vejde, když ano, vysází na aktuální místo, když ne, chová se jako \verb|\topinsert|) + \verb|\pageinsert| (podobné jako \verb|\topinsert|, jen se to roztáhne na celou stranu) = (ukončuje se \verb|\endinsert|), \verb|\raggedbottom| (udělá pružný \verb|\topskip| a nastaví output rutinu na to, aby ho přesunula dolu).

        \verb|\eject| (přechod do vertikálního módu a \verb|\break|, tedy ukončí stránku (pozor stránka se roztáhne na celou výšku, tedy je potřeba buď \verb|\raggedbottom| nebo přidat \verb|\vfill| před)), \verb|\supereject| (ukončí stránku a navíc vysype (klidně i na další stránky) všechny inserty) a \verb|\bye| (= \verb|\vfill\supereject\end|).
    \end{definice}

% 9. 11. 2020

    \begin{definice}[Značky]
        \verb|\mark{…}| udělá to, že vloží tzv. značku (nemá žádný vizuální význam). Output rutina se může ptát na \verb|\firstmark| (první značka na stránce), \verb|\botmark| (poslední značka na stránce) a \verb|\topmark| (vrací poslední značku předchozí stránky). Pokud na stránce nejsou značky, zůstávají značky z předchozí strany.

        Lze je použít například na slovník. (Většinou se používá poslední heslo této a poslední heslo minulé strany (protože přetéká na aktuální), proto top + bot).
    \end{definice}

\section{Rozebírání \TeX{}u}
    Input procesor - řádky -> token procesor - tokeny -> expand procesor - tokeny -> hlavní procesor (celé to řídí hlavní procesor, může expand procesoru říct, dej mi následující token neexpandovaný, nebo naopak expand procesoru vrátit poslední token. Zároveň přenastavuje parametry (protože přiřazuje do registrů), kterými se řídí ostatní procesory).

    \begin{definice}[Token]
        2 typy: dvojice (znak, kategorie) a řídící sekvence.
    \end{definice}

    \begin{definice}[Input procesor]
        Dostane pokyn přečti řádek a načte 1 řádek do řádkového bufferu. Převede kódování znaků do ASCII (rozšířeného o 1 bit). Následně odstraní konec řádku a mezery před ním (pozor, ne tabulátory apod., pouze mezery, pravděpodobně přežitek z konstatně dlouhých řádků na děrných štítcích) a na konec se přidá (pokud je mezi 0 a 255) \verb|\endlinechar| defaultně nastavený na 13.
    \end{definice}

    \begin{definice}[Kategorie]
        0-15:

        0 = \verb|\|, 1 = \verb|{|, 2 = \verb|}|, 3 = \verb|$|, 4 = \verb|&|, 5 = \verb|newline|, 6 = \verb|#|, 7 \verb|^|, 8 \verb|_|, 9 = \verb|ignored|, 10 = \verb|space|, 11 = \verb|písmeno|, 12 = \verb|ostatní|, 13 = \verb|aktivní (~)|, 14 = \verb|%|, 15 = \verb|invalid|.

        0, 5, 9, (10), 14, 15 „nevylezou“ z token procesoru, 10 vyjde jako ASCII mezera (ať to bylo cokoliv).

        \verb|\catcode64=14| změnilo zavináč na vlastnost komentáře (procento se nezměnilo) (to je to samé jako \verb|\catcode`@| nebo \verb|\catcode`\@|). Viz plain makro \verb|\makeatletter| a \verb|\makeatother| nebo to, že čísla jsou zapisována římsky (nesjsou písmena).
    \end{definice}

    \begin{definice}[Token procesor]
        3 režimy: N (newline), M (middle of line), S (shipping spaces)

        Kategorie 9 se vždy ignoruje, kategorie 15 se ignoruje a seřve tě.

        N = čte, dokud je to kategorie 10. Jakmile přečte něco jiného přemístí se na M. Když přijde náhodou newline, tak pošle dál token \verb|\par|.

        M = čte, doku nenačte kategorii 10. Jakmile se narazí na mezeru, přemístí se na S. Když přijde newline, pošle mezeru a přesune se na N. (Tedy od komentáře se liší jen mezerou.)

        S = čte, dokud je to kategorie 10. Jakmile přečte něco jiného přemístí se zpět na M. Když přijde newline, nic se nestane a přemístí se na N.

        Při potkání (kategoricky) \verb|^^xy| $x, y \in \{0-9, a-f\}$ vyrobí znak s tímto kódem a znovu se podívá na kategorie, pokud potká \verb|^^z| $z \in ASCII$, překlopí 6. bit (např. \verb|^^M…13…CR|, …).

        Pokud narazí (kategoricky) na \verb|\|, pokud následuje newline, tak vznikne token s prázdným názvem (a asi přejde do N), pokud následuje jiné nepísmeno, tak pošle token s jedním znakem (po mezeře přejde do S, po zbytku do M), pokud následují písmena, tak dočte do konce písmenek a přejde do (S).

        Po načtení \verb|%| zahodí zbytek řádku a přesune se do stavu N.
    \end{definice}

    \begin{priklady}
        \verb|\def\ahoj{Ahoooój!}| (token \verb|\ahoj| se nahradí Ahoooój!).

        \verb|\def\cara{\the\count0}| (se expanduje dvakrát).

        \verb|\def\b#{{\bf #1}}| (se při zavolání expanduje na \verb|{\bf …}| tedy na 3+? tokenů).

        \verb|\def\claim#1.{{\bf #1.}}|.
    \end{priklady}

    \begin{definice}[Expand procesor]
        U každého makra si pamatujeme seznam parametrů (separátory (jiné znaky) + čísla parametrů (předcházené \verb|#|) v pořadí (1, 2, …, 9)) a seznam náhrady (pravá strana definice = tokeny + placeholdery za parametry \verb|#|, musí být správně uzávorkováno kategoriemi).

        Expanze makra: ověříme separátory (před \verb|#1|), další parametry můžou být separované (v definici) parametr je pak do prvního výskytu separátoru na správné úrovni uzávorkování (pokud je správně uzávorkovaný, tak se odeberou krajní závorky (\verb|{}{} -> {}{}| ale \verb|{abc} -> abc|)), nebo neseparované, pak se smažou mezery a vezme se nejkratší neprázdný správně uzávorkovaný text s odebranými vnějšími závorkami (nebo jako samostatný znak, pokud to byl jen 1 znak) jako parametr.

        Výjimka, \verb|#{| značí, že \verb|{| je separátor, ale zůstane i po použití makra (\verb|\def\a#1#{<#1>}| se po zavolání \verb|\a123{456}| expanduje na \verb|<123>{456}| místo \verb|<1>23{456}|).

% 16. 11. 2020

        Při definici pomocí \verb|\def\xyz…{tělo}| se neexpanduje nic, při zavolání makra se volání s parametry nahradí tělem s doplněnými parametry, expand procesor se „vrátí“ (vytvoří nový input kanál, který se po projití zavře) a projde „znovu“ tělo.

        \verb|\def| je lokální, tedy se občas musí použít \verb|\global\def| nebo zkráceně \verb|\gdef|. Při definici se může expandovat i tělo příkazem \verb|\edef|, např. \verb|\edef\x{\the\pageno}| uloží do \verb|\x| číslice „aktuální“ (pozor na vracení se při zlomu) stránky. Dalším příkladem je \verb|\def\seznam{}    \def\pridej#1{\edef\seznam{\seznam #1}}| (ne moc dobrá definice, nevýhody jsou kvadratická složitost přidání a expandující se vložené prvky (lze opravit \verb|\noexpand|, ale expanduje se příště)). Globální \verb|\edef| je \verb|\xdef|.

        Existuje ochrana, že v parametrech běžně definovaných maker nemůže být \verb|\par| (pro lepší hlášení chyb), ta se dá vypnout \verb|\long\def…|. Naopak můžeme o makru říct, že nelze volat uvnitř skupiny, a to makrem \verb|\outer\def…| (lze odstranit přenastavením \verb|\outer| na \verb|\relax| před kompilací).

        \TeX  si pamatuje definice ve dvou tabulkách: table of meanings (řídící sekvence (cs) -> primitiva, registry, makra, znak, token typu dvojice) a definice maker. Makro \verb|\let cs [=] token| přiřazuje řídící sekvenci meaning daného tokenu. Meaning lze vypsat příkazem \verb|\meaning|.

        \verb|\noexpand token| zabrání (jednou) expanzi tokenu. \verb|\expandafter token1 token2| expanduje token2 a token1 „vrátí“ před něj a pokračuje expanzí od token1. Pomocí makra \verb|\number registr| (podobně jako \verb|the|) lze dostat číslice čísla v registru. Dále existují \verb|\romannumeral, \string^^A = ^_12 ^_12 A_12 |, pro velká římská čísla lze použít makro (zpracovávající se v hlavním procesoru) \verb|\uppercase{…}| (pozor, vnitřek neexpanduje, posílá ho zpět expand procesoru, takže to chce \verb|[\expandafter]\uppercase\expandafter{\romannumeral\pageno}|, první nemusí být, protože \verb|\uppercase| expanduje, aby „našel“ parametry), podobně \verb|\lowercase|, \verb|\jobname| vypíše název souboru, ze kterého \TeX aktuálně běží? \verb|\csname a_12 b_12 c_12\endcsname| vyrobí krabičku označenou ASCII hodnotami \verb|abc|. Takováto krabička se netestuje při expanzi (třeba na existenci, nebo právě jestli smí obsahovat \verb|\par|, nebo zda není \verb|outer|).
    \end{definice}

    \begin{priklad}
        \verb|{\catcode`@=\active\expandafter}\expandafter\def\noexpand @ \{tělo @\}| definuje @ jako aktivní znak, pak mu nadefinuje meaning, pak zavře skupinu a dodefinuje meaning zase se správnou kategorií.
    \end{priklad}

    \begin{poznamka}[Debug]
        Existuje makro \verb|\showbox N|, které do logu vypíše registr \verb|\box N|. Modifikovat (jak moc toho bude vypisovat) se dá pomocí hodnot „countů“ \verb|\showboxbreath| a \verb|\showboxdepth|.
    \end{poznamka}

    \begin{definice}[Podmínky]
        Podmínky se vyhodnocují v expand procesoru.
        
        \verb|\if…, YES[\else NO]\fi|

        \verb|\ifnmum \count 0 < 100|, \verb|\ifdim|, \verb|\ifhmode|
    \end{definice}

% 23. 11. 2020

    \begin{poznamka}
        I ve větvi, která se neexpanduje se počítá správné uzávorkování \verb|\if \fi| (dívá se do tabulky významů, nekontroluje text, neexpanduje).
    \end{poznamka}

    \begin{definice}[ifcase]
        \verb|\ifcase číslo větev 0 \or větev 1 \or větev 2 \or … \or větev n \else … \fi| expanduje tolikátou větev, jaké jsme mu dali číslo (zbytek zahazuje)
    \end{definice}

    \begin{definice}[Příklady podmínek]
        \verb|\iftrue| -- vždy pravdivý, \verb|\iffalse| -- vždy nepravdivý, \verb|\if Token1 Token2| (expanduje) -- porovnává znaky (krabiky porovnává jako znak 256 + kategorie 16), \verb|\ifcat Tok1 Tok2| (expanduje) -- porovnává kategorie, \verb|\ifx Tok1 Tok2| (neexpanduje) -- porovnává význam (makra porovnává jako seznamy, porovnává znak i kategorii, krabičky bez významu jsou shodné), \verb|ifnum Num1 Rel Num2| -- porovná celá čísla (relace jsou pouze 3: $= < >$, zbytek se dělá \verb|\else|), podobně \verb|\ifdim| pro rozměry, \verb|\ifhbox N|, \verb|\ifvbox N|, \verb|\ifvoid N| -- stav boxového registru, \verb|\ifhmode/vmode/mmode| -- v jakém jsme módu hlavního procesoru, \verb|\ifinner| -- ptá se na vnitřní mód hlavního procesoru, \verb|\ifodd Num| -- lichost čísla, \verb|\ifeof Kanál| -- ptá se na EOF na daném kanálu.
    \end{definice}

    \begin{upozorneni}
        Definování svého if většinou strašně vybuchne.
    \end{upozorneni}

    \begin{poznamka}
        Podmínka se správně definuje pomocí \verb|\newif\ifabc| vyrobí 3 makra \verb|\ifwide|, které se chová, jak bychom očekávali (má význam podmínky), \verb|\abctrue/\abcfalse|, což jsou přepínače, které dané if nastaví na \verb|\iftrue/\iffalse| (podmínky se pak vytvoří tak, že definujeme testovací makro, které pak spustí \verb|\abctrue/\abcfalse|).
    \end{poznamka}

    \begin{definice}[Smyčky]
        Všechny smyčky v \TeX u jsou vytvářeny jako tail-rekurze (viz dekorátor v Kotlinu).

        V Plainu \verb|\loop…\if…\repeat|, kde \verb|\iffalse| provede klasický break (\verb|\repeat| má význam \verb|\fi|). Při vnoření cyklů to chce vnitřní cyklus uzavřít do group.
    \end{definice}

    \begin{poznamka}
        Pokud potřebujeme vyrobit nepárové uzávorkování, tak máme příkazy \verb|\begingroup| a \verb|\endgroup| na přenastavování „proměnných“. Na druhý význam uzavření parametrů lze využít \verb|\bgroup| a \verb|\egroup|, které mají významy závorek přiřazený pomocí \verb|\let|.
    \end{poznamka}

    \begin{definice}[Token-listové registry]
        \verb|\toks0…255|, \verb|\newtoks|, jako ostatní registry.

        \verb|\newtoks\t| $\rightarrow$ \verb|\t[=]{token…}| se bere bez expanze, expanze proběhne \verb|\the\t| (pozor, uvnitř \verb|\edef| se obsah neexpanduje). Toho lze využít pro definici seznamů.

        Příklady (interní = možná mají záporné indexy, ale to je jedno ;) ): \verb|\output|, \verb|\everypar| -- provede se každý odstavec (po vložení \verb|\indent| nebo \verb|\noindent|) a jeho obdoby \verb|\everyhbox/vbox/math/display/cr/job|, \verb|\aftergroup token| -- spustí se po ukončení aktuální group (tyto tokeny se akumulují), \verb|\afterassignment token| -- spustí se při dalším přiřazení (tyto tokeny se ne!akumulují, hodí se na parsování dimenzí), \verb|\futurelet\cs Tok1 Tok2| -- odpovídá \verb|\let\cs=Tok2|, ale nechává Tok1 a Tok2 na místě (lze použít na nepovinné parametry).
    \end{definice}

    \begin{definice}[Rozebrání krabičky]
        V makru \verb|\newif| se musí rozebrat krabička. To se udělá pomocí \verb|\string| (pozor, vyrábí vše s kategorií 12) a \verb|\escapechar=-1| (\verb|\| s hodnotou mimo 0…255 se přeskočí).

        Existuje špinavý trik, jak vyrobit libovolný znak s libovolnou kategorií: přenastavíme tabulku \verb|\uppercase| (protože nechává kategorii, mění jen znak) pomocí \verb|\uccode`znak=`znak|.
    \end{definice}

% 30. 11. 2020

\section{Tabulky}

    \begin{definice}[Tabulka]
        Tabulka se vyrábí \verb|\halign[to/spread <dimen>]{šablonka\cr řádek \cr řádek \cr … \cr}|. Jednotlivé sloupce (včetně šablony) se oddělují \verb|&|. (Existuje i \verb|\valign|, které vyrobí tabulku s prohozenými řádky a sloupci). Pozor to/spread funguje pouze na glue (\verb|\tabskip|) mezi buňkami, ne na sloupce samotné.

        Šablona musí vypadat \verb|a1#b1&a2#b2&…\cr| (ai a bi jsou sekvence tokenů, neexpandují se až na výjimky: makro \verb|\span|, které expanduje následující makro, a \verb|\tabskip|, kde se najde přiřazení do registru a použije se na následující mezisloupcové mezery, po \verb|\cr| ztrácí význam). Periodickou šablonu lze vyrobit \verb|X&…&Y&&Z&U\cr|, kde X až Y je předperioda a Z až U je perioda. Bez předperiody: \verb|&Z&…&U|.

        Vysází se tak, že se nejdřív vygenerují všechny řádky, pak se podívá na jednotlivé sloupce a vezme maximum z jejich přirozených velikostí. Při expanzi řádku se vždy nakoukne na první token datové položky a pokud není speciální (\verb|&/\cr|) vloží se konkrétní \verb|a|. Následně se vloží datová položka a konkrétní \verb|b|. Kompletuje se to jako vnitřní horizontální mód, ale nejdřív se jen spočítá přirozená velikost. Po zjištění šířek se každá buňka zabalí do \verb|\hbox| šířky sloupce a pak se zkompletuje celý řádek jako \verb|\hbox| obsahující \verb|\hbox|y a \verb|\tabskip|y.

        \verb|…\cr\noalign{vertikální materiál}| vysází za aktuálním řádkem vertikální materiál (případná \verb|\hrule| se vysází na šířku tabulky a ne zrcadla). \verb|\omit| zase nahradí šablonu v aktuální buňce pouhým \verb|#| (vysází se pouze obsah bez daného \verb|a| a \verb|b|). \verb|\span| k této buňce přilepí následující sloupec, většinou se ještě obaluje: \verb|\omit\span\omit| (plain má makro\verb|\multispan X|, které slepí (i s \verb|\omit|y) X sloupců k sobě), na toto slepení se prvně vůbec nebere ohled při výpočtu šířky sloupců, pokud se to nepovede bez ohledu, tak se nějak „hloupě“ (většinou ne tak, jak bychom chtěli) roztáhnou sloupce, aby to vyšlo, takže to chce vložit do tabulky podpěry, aby se tam sloučené buňky opravdu vešli.

        Ohraničení se všechny dělají linkami.
    \end{definice}

    \begin{definice}[Leaders]
        \verb|\leaders <box/rule> <rozměr>| (máme předdefinováno \verb|\hrulefill|, \verb|\vrulefill|, \verb|\dotfill|), leaders má ve skutečnosti 3 varianty: \verb|\leaders| (zaokrouhlí materiál, aby byl násobkem velikostně boxu, který má leaders vysázet), \verb|\cleaders| (chybu (pokud není místo celočíselný násobek boxu) dá půl na začátek, půl na konec), \verb|\xleaders| (rovnoměrně rozloží chybu do mezer mezi boxy).
    \end{definice}

\section{Práce se soubory}
    \begin{definice}[Streamy]
        Zápisové streamy 0…15. Zapisuje se \verb|\newwrite\soubor| následovaný \verb|\openout\soubor=jméno|, následně lze používat \verb|\write\soubor{tokeny}| a ukončuje se \verb|\closeout\soubor|. Tyto příkazy se neexpandují, pouze se ukládají a až při \verb|\shipout| a tam se expandují (včetně ukládaných tokenů). Pokud chceme tyto příkazy vykonat okamžitě, připíšeme před ně \verb|\immediate|. Zápis do zavřeného streamu píše do logu a pokud je číslo $≥$ 0 tak se dokonce vypisuje i na output, tedy speciálně \verb|\write16| se používá pro zápis do logu a terminálu.

        Čtecí streamy 0…15 se používají podobně (jen se vyhodnocují okamžitě) \verb|\newread\soubor|, \verb|\openin\soubor=jméno|, \verb|\read\soubor to \xyz| (spíše se nepoužívá), \verb|\ifeof\soubor| (pomocí toho se zjišťuje, zda dokument existuje), \verb|\closein\soubor|.
    \end{definice}

    \begin{definice}[Special]
        S tím souvisí \verb|\special|, který je také takzvané whatsit (nejsou součátstí TeXu, ale je to jen naše dohoda s konvertorem, že je použije). Jelikož \TeX neumí barvičky, obrázky a spol, tak se takové věci dají vložit \verb|\special|. Dnes jsou ale spíše zastaralé, protože se dnes spíše používají přímo pdftexy, které se o to starají už sami.
    \end{definice}

% 7. 12. 2020

\section{Matematický mód}
    \begin{definice}[abovewithdelims]
        \verb|\abovewithdelims()xpt| vysází něco jako zlomek se zlomkovou čarou tloušťky $x$ a s delimitry (závorkami) „(“„)“, které nemusí být prázdné, mohou být dokonce „žádné“ (pouze mezera): „.“ (tam se použije mezera \verb|\nulldelimetter|).

        Speciální případy jsou \verb|citatel \over jmenovatel|, \verb|n \choose 2|, \verb|n\atop k|.

        Automaticky se vycentrovává pomocí \verb|\hfill|, tedy lze ho přebít \verb|\hfilll|.
    \end{definice}

    \begin{definice}[Delimeters]
        Delimiters se dají upravit pomocí \verb|\left(…\right)|, což si změří obsah a podle toho natáhne závorky (těch existuje několik typů).

        Existují i explicitní varianty (v plainu): \verb|\big( \Big( \bigg( \Bigg(\|, které jsou zkonstruované pomocí podpěr. Respektive \verb|\bcosil\bcosir\bcosim| kvůli mezerám vlevo, vpravo a ve středu.
    \end{definice}

    \begin{definice}[Odmocnina]
        Odmocnina (\verb|\sqrt{…}|) je speciální konstrukce, $n$-tou odmocninu (\verb|\sqrt[n]{…}|) už řeší plain.
    \end{definice}
    
    \begin{definice}[Akcenty]
        

        \verb|\tilde…| (resp. \verb|\widetilde{……………}|), \verb|\overline…|, \verb|\underline…|, \verb|\overbrace…|, \verb|\underbrace…| (za to se dají napsat meze, tedy \verb|\underbrace{x+(x+1)+\ldots}_\hbox{$k$ členů}$|)
    \end{definice}

    \begin{definice}[Styly]
        4 (resp. 8): D = display (\verb|$$…$$|), T = text (\verb|$…$|), S = script (index, exponent, čitatel, jmenovatel), SS = scriptscript (vnořené S). \verb|\atop| způsobuje (nahoře / dole) D$->$T/T', T$->$S/S', S$->$SS/SS', SS$->$SS/SS'. Indexy D$->$S, T$->$S, S$->$SS, SS$->$SS.

        Každý ze 4 stylů existuje ještě čárkovaná varianta, která říká: „nade mnou ještě něco je“ (tedy dolní index přesouvá do čárkovaného a z čárkovaného se jde do čárkovaného).

        Lze je explicitně přepínat pomocí \verb|\displaystyle| apod. Naopak v makru mohu použít \verb|\mathchoice{D}{T}{S}{SS}|, které definuje, jak se má co vysázet (jednodušeji to nejde, jelikož styl se propaguje doprava i doleva). Existuje i plainové makro \verb|\mathpalette\t#1|, které umožní propagovat styl přes nematematický mód.
    \end{definice}

    \begin{definice}[Matematický seznam]
        Obsahuje:
        \begin{itemize}
            \item atomy
            \item dočasné značky (např. \verb|\left|)
            \item glue / math. glue (jednotky mu) / nonscript (glue, jež se vloží jen mimo S a SS).
            \item kern / math. kern (jednotky mu)
            \item změny stylu
            \item mathchoice
            \item horizontální materiál: linky / penalty / discretionary (nobreak musí být prázdný a parametry nejsou matematické listy, ale horizontální listy)
            \item vertikální materiál: mark / insert / vadjust
            \item whatsit
            \item zlomek (hned po doparsování se z něj stává atom)
        \end{itemize}
    \end{definice}

    \begin{definice}[Atomy]
        \ 
        \begin{itemize}
            \item[0] Ord (ordinaly)
            \item[1] Op (velký operátor)
            \item[2] Bin (binární operátor)
            \item[3] Rel (relace, lze za ním zlomit)
            \item[4] Open (otevírací delimetter)
            \item[5] Close (zavírací delimetter)
            \item[6] Punct (interpunkce, nelze za ní zlomit)
            \item[7] Inner (mezi \verb|\left| a \verb|\right|)
            \item[8] Over (\verb|\overline|)
            \item[9] Under (\verb|\underline|)
            \item[10] Acc (akcenty)
            \item[11] Rad (\verb|\sqrt|)
            \item[12] VCent (\verb|\vcenter{…}|)
        \end{itemize}

        Prvních 8 lze vyrobit z jiných atomů zavoláním \verb|\mathrel| apod.

        Znaky v matematice mají krom \verb|\catcode| ještě \verb|\mathcode`znak="TFXY| TFXY je hexadecimální (T = typ atomu 0…7, F = typ fontu, XY = pozice znaku ve fontu). Pokud kód TFXY je 8000, tak se v matematice (a pouze tam) chová jako aktivní (makro se musí definovat tak, že se přenastaví catcode a pak se vrátí). Navíc T=7 způsobí, že se použije rodina podle \verb|\fam|$\in \{0, …, 15\}$, nebo F, pokud není v intervalu a vygeneruje se atom Ord (toho využívá napr. \verb|\bf|).

        Znaky z daným kódem lze explicitně (bez žádného znaku) dají vygenerovat jako \verb|\mathchar"TFXY|. Nebo si můžeme vytvořit pojmenovaný znak \verb|\mathchardef\jmeno="TFXY|.

        S delimetry je vše jinak, \verb|\delcode'(=F_1X_1Y_1F_2X_2Y_2| (1 = základní velikost a 2 = první větší). Explicitní je \verb|\delimiter"TF_1X_1Y_1F_2X_2Y_2|, kde T je typ (open / close / rel).

        Stejně tak radical jde vyrobit \verb|\radical"F_1X_1Y_1F_2X_2Y_2|.
    \end{definice}

    \begin{definice}[Mezery]
        Běžná se ignoruje, s lomítkem podle fontu, \verb|\hskip 1em| funguje normálně, \verb|\hskip 1mu|, kde zpravidla $1mu = \frac{1}{18}em$ fontu pro daný styl.

        Navíc existují rozměry \verb|\thinmuskip| (\verb|\,| nebo záporná : \verb|\!|), \verb|\medmuskip| (\verb|\>|) a \verb|\thickmuskip| (\verb|\;|). Např. \verb|\int x^2 \,{\rm d}x| nebo \verb|1\,{\rm km}| nebo \verb|\int\!\int|.
    \end{definice}

    \begin{poznamka}[Lámání T modu]
        Vkládají se automatické penalty \verb|\binoppenalty| a \verb|\relpenalty|. Jinak se láme na explicitních penaltách a discr.
    \end{poznamka}

% 14. 12. 2020

    \begin{poznamka}[Úplně mimo]
        \#\# umožňuje vložit \# do expanze makra.
    \end{poznamka}

    \begin{definice}[Mezery mezi atomy]
        V TeXbooku naruby máme tabulku. Velké mezery mizí (a malá se zmenšuje, protože je v mu) v S a SS.

        Navíc Bin se ve skoro všech případech mění na Ord.
    \end{definice}

    \begin{definice}[Mathsurround]
        Dimen, který se vkládá před a po matematickém módu (NEPOUŽÍVAT, rozbíjí to neplainová (ten si to automaticky přenastavuje) makra). Změnou v matematice se změní jen pro aktuální matematiku.
    \end{definice}

    \begin{definice}[Displayed Math]
            \verb|$$formule[\[l]eqno formule v textové matematice]$$| Formule se centruje na šířku zrcadla - z obou stran 1em a \verb|\[l]eqno| (\verb|\[l]eqno| = číslo rovnice sázené v[levo]pravo). Nevejde-li se: 1. smršťujeme formuli, 2. centrujeme do zbylého místa (= zahodí se místo pro nesázené eqno (buď levé nebo pravé, podle toho, jestli máme pravé, nebo levé)).

            \verb|\left/rightskip| se neuplatňuje, \verb|\hang/parshape| ano. Formule se počítá za 3 řádky odstavce (mezera, formule, mezera). Při spuštění (první \verb|$$|) se nastaví, v průběhu ho lze tedy měnit, při ukončení (druhých \verb|$$|) se použije.

            Před se vloží \verb|\predisplaypenalty + abovedisplay[short]skip| a po se vloží \verb|\postdisplaypenalty + belowdisplay[short]skip| (short se použije, pokud předchozí řádek „končí“ (vizuálně + 2em) dřív než začíná matematika, konec odstavce = \verb|\predisplaysize|, eqno se ignoruje, když je šířky 0, nebo pokud eqno začíná \verb|\rlap|, čímž se vysází číslo místo mezery za displaymath). Následuje odstavec bez \verb|\indent|.
    \end{definice}

    \begin{definice}
        \verb|$$ \halign{…} $$| se vysází (hlavně odsadí) jako display math, do odstavce se počítá zase jako 3 řádky.

        Lze dokonce i vycentrovat: \verb|$$ \vbox{\halign{…}} $$|, pak se ale neláme stránka uvnitř (bez \verb|\vbox| ano).
    \end{definice}

    \begin{definice}
        \verb|\eqalign{…&…\cr…&…\cr…}| sází rovnice se zarovnanou (1, jen 2 sloupce) věcí pod sebe. Sází se jako \verb|\vcenter| = nedělitelné, lze použít „kdekoliv“.
        
        \verb|\[l]eqalignno{…&…&n_1\cr…}| sází podobně jako výše, ale i s číslem. Dá se v něm lámat.
    \end{definice}

\section{Fonty}
    \begin{definice}[Základní font TeXu]
            cmr10 [at 12pt / scaled 1100] = (cm = computer modern) + (r = roman, jiné možnosti (ti = text italic), (mi = math italic), (b = bold), (bx = bold extended, \verb|\bf|), (tt = typewriter), (sl = slanted)) + (10 = design size 10pt = jak velká byla destička s daným písmenem (konvence tiskařů)) + (at 12pt = velikosti 12pt, pozor nerovná se cmr12, jiné velikosti (cmr12) písmen vypadají jinak) + (scaled 1100 = naškáluj na 1100 promile).

            Nastavuje se \verb|\font\cs = cmr10 [at 12pt / scaled 1100]| a pak se dá použít (např. mimo matematiku pouhé \verb|\cs| v matematice \verb|\textfont family = \cs|).

        Název aktuálního fontu získáme \verb|\fontname\font|.
    \end{definice}

    \begin{definice}[fontdimen]
        \verb|\fontdimen číslo \cs| je registr pro daný fontdimen, kde číslo =
        \begin{enumerate}
            \item stant (sklon, jaká je šířka na 1pt výšky)
            \item Mezislovní mezery
            \item -||-
            \item -||-
            \item ex
            \item em
            \item extra mezera (viz \verb|\xspaceskip|)
        \end{enumerate}
    \end{definice}

    \begin{poznamka}
        Ještě se lze ptát na \verb|\hyphenchar\font| = kód rozdělítka a \verb|\skewchar\font| = matematické cosi.
    \end{poznamka}

    \begin{poznamka}
        \verb|\magnification promile| znásobí velikost od zavolání do konce jobu (hlavně v dvi), 12truept je 12pt při ignorování magnification. Navíc existuje \verb|\magstep n| = \verb|\magnification 1000 * 1,2^n| a \verb|\maghalf| = \verb|\magnification 0.5|.
    \end{poznamka}

    \begin{definice}[Soubory]
        Začíná se souborem .mf, ten METAFONT převede do .tfm (metriky) a .gf („obrázky“). .gf závisí na rozlišení a podobných věcech (celkově třeba tiskárně) se dále převede pomocí GFTOPK .pk („obrázky2“). TeX použije metriky (.tfm) a vyrobí .dvi. DVIPS potom vezme .dvi a .pk a vyrobí z toho .ps.

        TeX už většinou umí volat METAFONT, kdyby nenašel chtěné soubory.

        Pro .gf, .pk a .dvi existují programy na prohlížení (GFTYPE, PKTYPE, DVITYPE). .tfm se dá překládat tam a zpět pomocí PLTOTF a TFTOPL.

        Co je TFM: základní hlavička (jméno, design size) + rozměry znaků (w/h/d + italické korekce, kódované přes omezeně velkou tabulku (pouze 64 různých šířek písmen $\rightarrow$ METAFONT dělá ztrátovou kompresy)) + program pro kerny a ligatury + seznam variant pro velké operátory a delimitery + fontdimens.
    \end{definice}

    \begin{definice}[Postscriptové fonty]
        Type1 (= bezierovské segmenty), type3 (= PS programy), type32 (= bitmapy), type42 (= TrueType zabalený do PS), type0 (= composite fonty).

        Jsou 2 soubory .pfa (častěji komprimovaná verze .pfb) a afm (adobe font metric, komprimovaně .pfm). Do TeXu: .pfm PFMTOAFM .afm AFM2TFM .tfm TEX .dvi DVIPS(+.pfa/.pfb) .ps.

        Nebo (tzv. systém virtuálního fontu) AFM2TFM může ještě dostat .enc, čímž se ještě vyrobí .vpl, ze kterého se VPTOVF vytvoří .tfm pro TEX a .vf pro DVIPS. (Existuje i inverzní VFTOVP).

        DVIPS navíc ještě dostává font map (jeden řádek = \verb|rptmr Times-Roman < ptur_8a.pfb| = jméno v TeXu + jméno v PostScript světě + „vlož“ (=$<$) + soubor).
    \end{definice}

    \begin{definice}[TrueType fonty]
        Vznikly ve Windows, mají jen beziérky druhého řádu (= jsou omezené). Lze je převést .ttf TTF2AFM .afm, nebo (.tff TTF2TFM .tfm + .tff TTF2PK .pk).
    \end{definice}

    \begin{definice}[OpenType]
        Kontejnerový obal, do kterého lze uzavřít skoro cokoliv (většinu PS a všechny TT). Existují převáděcí programy OTF2…
    \end{definice}



\end{document}
